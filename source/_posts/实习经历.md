title: "实习经历"
date: 2015-07-29 16:30:50
tags: 职业规划
---

## 所做的事
我实习做的事主要是：用EXCEL表整理一些配置数据；每天跟踪室内的质量检查报告，并提醒当事人；改了三个bug。另外，一开始主管还让我把一个系统从跑在小型机上改成分布式的。
<!-- more --> 
### 第一个是业务分析系统异常分析原因显示不出来的bug。
bug的表现是：某几天的异常分析系统界面上异常原因没有，其它天的表现正常。

异常分析的逻辑：简要地说是这样的，根据每天的交易明细数据，每天都会统计全国十五大银行和每个地区银行的交易笔数，交易成功率和交易金额。然后每天都会对交易量，交易成功率，交易金额建立基线。所谓的建立基线就是对过去的七天求平均。判断十五大行和地区交易异常的逻辑是看当天的交易成功率是否低于基线的三倍标准差。而对于地区的异常，还会进一步判断是地区下面的哪一个银行（地区性银行）导致了地区的异常，然后根据这些出现异常的银行给出异常原因。出现bug主要是地区的异常。

分析过程：我把出现bug的某一天的数据从生产环境导到测试环境，然后单步执行异常分析模块的代码，最后定位出来的出现bug的代码。发现原来地区下面银行的异常分析逻辑出现问题。原来判断地区下的银行的异常逻辑是看该银行的交易失败量是否出现明显的增多，表现在代码里是看*(1 - 该机构当天成功率) x 该机构当天交易笔数 - （1 - 该机构基线成功率）x 该机构交易笔数基线*是否大于零。执行出现bug的那一天数据的时候发现这个条件不成立，然后异常分析的时候就不把该机构当做异常机构，没有异常机构也就没了异常原因。不成立的原因是该机构当天的交易笔数突然就下降了非常多，尽管该机构交易成功率保持不变，但是(1 - 该机构当天成功率) x 该机构当天交易笔数明显就比（1 - 该机构基线成功率）x 该机构交易笔数基线小得多。仔细想想，这段代码逻辑明显就有很大的问题。
判断地区下面机构的异常的问题可以抽象成：地区交易成功率出现了明显的下降了，是地区下面那个机构导致的。也就是∑每个机构当天成功率x每个机构当天交易笔数 / 地区当天的总交易笔数 突然下降了，是哪个机构导致的。仔细分析会发现，这里面有很多因素会导致地区成功率的下降，比如某个机构当天成功率突然下降了好多，或者某个机构当天交易笔数突然下降了很多，或者两个同时下降也会导致下降。经过这么个分析，是不是可以说某个机构当天对地区的成功率贡献率是否下降（这个机构当天成功率 x 这个机构当天交易笔数 / 地区当天的总交易笔数 和 这个机构当天成功率基线 x 这个机构当天交易笔数基线 / 地区当天的总交易笔数基线 相比低）就可以定性这个机构为异常呢。其实，也并不是这样。还有几个问题：

+ 因为有可能有些机构贡献率降了，而有些机构贡献率升了。导致一些没有异常的机构也被我们定性为异常了，出现了误判，也就是本来该地区就没有异常的，用了这个条件以后反而导致该地区下面机构有异常了。明显跟判地区异常的逻辑出现了矛盾。
+ 机构对地区成功率贡献率比机构基线对地区成功率贡献率低多少呢？阀值定为多少才精确呢。
+ 如果采用上面的标准，会有很多交易笔数很少的机构也会被判为异常

我给出的方案是这样的：
+ 针对第一个问题，我加了个判断条件，就是如果地区没有异常，那么地区下面的机构的异常就被排除。
+ 针对第二个问题，我目前没有相出合适的方法精确定义这个阀值，也就是我没有能从数学上去证明这个阀值究竟设为多少。如果你有证明方法，欢迎通过评论给出。我定的阀值是0。阀值是0还是会导致很多误判，这个也通过第一个问题给出的方案来解决。
+ 针对第三个问题，我给出的方案是只有机构交易量占地区交易量占比大于1%才判断机构是否有异常。

加了上面的条件以后，我以为可以了。但是测试的时候还是不行，上面的条件还是会导致误判，就是地区有异常，判断机构的异常还是会出现误判。也就是说，上面条件还是不够强。后来，跟主管沟通了一下，主管说这个给出异常原因只是给个参考，不需要很精确的。最后，我就又加了一个强条件，如果机构成功率比该机构基线成功率低，才会对机构判异常。加了这个条件以后，拉下一个多月的数据测试没有问题，上线以后也再也没有问题。

一点感想：我一直在思考，上面那个问题有没有数学上证明的精确的判断条件呢。但是，这段代码原始的逻辑明显经不起推敲，感觉他们写代码就是靠运气，这估计就是《代码大全》里面说的撞大运式编程吧！在理解异常分析子模块的时候，不断地单步跟踪和看设计文档，在这过程中发现，设计文档明显跟代码不一致，一些常量如阀值在代码里跟设计文档里完全不一样，让我越加有这种感觉。改好bug，上线过程中，出现一点小插曲。就是我改过的代码在测试环境完全没问题，在生产线上跑的时候出现问题了，所有数据都是乱的。当时主管就急了，说你看看你改的东西，搞成这个屌样了。后来不断地查错，才发现是他少跑了一个任务，就是异常分析任务之前的任务没跑，导致输入的数据都是错的，所以出现了乱的数据。事后，我也反思这个事，倒不是说主管怎么地，碰到紧急情况谁都会着急，而是流程的问题。我在想为什么没有严格的测试（不仅仅是靠我测）和code review。人非圣人，总有犯错的时候。这时候在入代码库的时候严格的测试和code review就可以减少一些人为的错误。

### 第二是sum溢出的bug
bug表现：交易主系统界面上表示基线的绿色线没有显示出来。

分析过程：通过读该子系统的源代码和单步调试重现，发现问题出在执行一条数据库语句上，select SUM(NUM) from XXX 上，某一天交易数据比较大的时候SUM(NUM)溢出了，通过看该数据库的表发现NUM是整数。我一开始认为这个比较简单，把数据表的NUM列的类型调整成BIGINT不就行了吗？后来主管说，这个方案不行，改成BIGINT会明显增加数据库的存储空间，他给的建议是调整业务代码的逻辑，存的时候除以1000.0，显示的时候再不用再除了（业务逻辑是显示交易的万笔数）。我认为这个方案还是不够好，涉及到改业务代码，还要进行严格测试。改动的业务代码影响的代码都必须得测试确认。最后想出来的方案是sum的时候cast成BIGINT，也就是既不会增加存储空间，也不会改动业务代码。看到这里，你可能也认同这是一个完美的方案。但是，还有一个问题，cast成BIGINT，DB2和MYSQL没有统一的语法，而DB2和MYSQL在生产线都在用，有可能从一种库切到另外一种库。后来跟主管沟通，主管说暂时没有切的打算，以后的事情以后再说。

一点感想：修正这个bug倒不是难得事情，而是在这过程中，要考虑很多因素。不仅仅是正确性，还要考虑性能，兼容性，健壮性。

### 第三是JAVA decimal format格式化的问题。
这是个小问题，没啥好说的，就是之前代码里面格式成两位小数的时候用的是DecimalFormat("#.00")，这有个问题是0.XX就只会显示成.XX，明显不符合习惯，后来我把它改成DecimalFormat("0.00")就改正了这个bug。

一点感想：这个bug虽小，倒是提醒了我写代码要考虑全面。

## 为什么提前回来
做出提前回来的决定是考虑了很久的，去了一个多月，交了四个月的房租（压一付三，坑爹呀），这就是所谓的沉没成本吧。提前回来意味着放弃了直接拿工作offer的机会，自我感觉拿offer的机会比较大。毕竟待遇挺好，相比于一线互联网公司都好，又朝九晚五的，偶尔加班，工作强度比一线互联公司低得多。但是，发现自己不喜欢维护别人的东西，每次都问自己，如果以后工作了做现在这个岗位的东西，我愿意吗？内心答案是：不。现阶段，我考虑的还是：可以学到东西，工作的潜力。毫不保留地跟主管提出了自己的想法：想去互联网公司做开发，目前还是想学点技术。主管虽然也提出了挽留，但也表示理解，还是说祝顺利。在这里，真的要谢谢黄总和覃总，他们一直很nice，特别是黄总，在我提出离职要走了，办离职手续的时候还各种帮忙。走出学校碰到的老大这么nice，是一种幸运。